<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <title>Lista produktów</title>
</head>
<body>
<h1>Katalog produktów</h1>

<fieldset>
    <legend>Filtrowanie</legend>
    <form th:action="@{/product-list}" method="get" style="display: flex; gap: 10px; align-items: flex-end;">

        <div>
            <label>Fraza (w nazwie lub kategorii):</label><br>
            <input type="text" name="phrase" th:value="${param.phrase}" />
        </div>

        <div>
            <label>Cena Min:</label><br>
            <input type="number" step="0.01" name="minPrice" style="width: 70px;" th:value="${param.minPrice}" />
        </div>
        <div>
            <label>Cena Max:</label><br>
            <input type="number" step="0.01" name="maxPrice" style="width: 70px;" th:value="${param.maxPrice}" />
        </div>

        <div>
            <label>Kategoria:</label><br>
            <select name="categoryId">
                <option value="">-- Wszystkie --</option>
                <option th:each="cat : ${categories}"
                        th:value="${cat.id}"
                        th:text="${cat.name}"
                        th:selected="${param.categoryId == cat.id}">Pokarm</option>
            </select>
        </div>

        <div>
            <input type="submit" value="Filtruj" />
            <a th:href="@{/product-list}">Wyczyść</a>
        </div>
    </form>
</fieldset>
<hr>

<p sec:authorize="hasRole('ADMIN')">
    <a th:href="@{/product/add}">Dodaj nowy produkt</a>
</p>

<p>
    <a th:href="@{/}">Menu Główne</a> |
    <span sec:authorize="isAuthenticated()">Zalogowany jako: <b sec:authentication="name"></b></span>
    <span sec:authorize="!isAuthenticated()"><a th:href="@{/login}">Zaloguj się</a></span>
</p>

<div th:if="${#lists.isEmpty(products)}">
    <p>Brak produktów w sklepie.</p>
</div>

<table border="1" th:unless="${#lists.isEmpty(products)}">
    <thead>
    <tr>
        <th>ID</th>
        <th>Zdjęcie</th>
        <th>Nazwa</th>
        <th>Kategoria</th>
        <th>Cena (PLN)</th>
        <th>Data ważności</th>
        <th>W magazynie</th>
        <th>Status</th>
        <th>Wymiary (SxWxG)</th>
        <th>Tagi</th>
        <th>Utworzył</th>
        <th>Zmodyfikował</th>
        <th>Data utworzenia</th>
        <th>Ostatnio zmodyfikowane</th>
        <th>Opcje</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="prod : ${products}">
        <td th:text="${prod.id}">1</td>

        <td>
            <img th:if="${prod.imagePath != null}"
                 th:src="@{'/product-images/' + ${prod.id} + '/' + ${prod.imagePath}}"
                 width="50" height="50" style="object-fit: cover;" />
            <span th:if="${prod.imagePath == null}">Brak</span>
        </td>

        <td th:text="${prod.name}">Nazwa produktu</td>
        <td th:text="${prod.category.name}">Kategoria</td>
        <td th:text="${#numbers.formatDecimal(prod.price, 1, 2, 'COMMA')}">99,99</td>
        <td th:text="${prod.bestBeforeDate != null ? #temporals.format(prod.bestBeforeDate, 'dd-MM-yyyy') : '-'}">01-01-2025</td>
        <td th:text="${prod.inStock ? 'Tak' : 'Nie'}">Tak</td>
        <td th:text="${prod.status.description}">Dostępny</td>
        <td th:text="${{prod.dimensions}}">-</td>
        <td>
            <span th:each="tag : ${prod.tags}" th:text="${tag.name}" style="display: block;">Promocja</span>
        </td>
        <td th:text="${prod.createdBy}">Admin</td>
        <td th:text="${prod.lastModifiedBy}">Admin</td>
        <td th:text="${prod.createdDate != null ? #temporals.format(prod.createdDate, 'yyyy-MM-dd HH:mm:ss') : '-'}">Data</td>
        <td th:text="${prod.lastModifiedDate != null ? #temporals.format(prod.lastModifiedDate, 'yyyy-MM-dd HH:mm:ss') : '-'}">Data</td>
        <form th:action="@{/cart/add}" method="post" style="display:inline;">
            <input type="hidden" name="productId" th:value="${prod.id}"/>
            <input type="submit" value="Do koszyka"/>
        </form>
        <td>
            <a sec:authorize="hasAnyRole('USER')" th:href="@{/product-details(id=${prod.id})}">Szczegóły</a>
            <span sec:authorize="hasRole('ADMIN')">
                | <a th:href="@{/product/edit/{id}(id=${prod.id})}">Edytuj</a>
                | <a th:href="@{/product-delete(id=${prod.id})}">Usuń</a>
            </span>
        </td>
    </tr>
    </tbody>
</table>
</body>
</html>